---
title: 进程守护者
date: 2019-09-15 16:25:42
tags:
    - go
categories:
    - go
---


公司里有一个监控Windows服务、IIS应用程序池的程序，这次把它尝试用go重写了一次。

### 需求：

1.  读取配置文件中的Windows服务、IIS应用程序池。
2.  定时去检测是否运行正常
3.  将非启动状态的服务、应用程序池启动

<!-- more -->

### 以下为本次学习到的新内容

1.  自定义package

    先执行`go build`，再执行`go install`，这样才能在其它包中使用。

2.  Windows服务

    go没有直接操作Windows服务的相关api，所以只能通过Windows自带的工具去处理，在命令行输入相关内容，再解析输出结果。

    1.  查看：`cs query state=all`，该语句会输出所有的Windows服务信息。

        这里有个地方得注意下，在go程序里执行没问题，在cmd里执行该语句也是正常的，但是在PowerShell里执行的话，会在执行命令的目录下生成一个文件名为：`query`的文件，文件内容是`state=all`。

        PowerShell里跟Windows服务相关的命令是：`Get-Service`，具体参数目前还没有去了解。

    2.  启动：`cs start "服务名称"`，该语句会启动指定的Windows服务。

3.  IIS 应用程序池

    IIS 7以后新增了`appcmd.exe`工具，路径为`C:\Windows\System32\inetsrv\appcmd.exe`，使用该工具可以查看、操作应用程序池。在go里的实现也是先执行相关命令，再解析输出结果。

    1.  查看：`appcmd list apppool`，该语句会输出所有的IIS应用程序池。
    2.  启动：`appcmd start apppool "程序池名称"`，该语句会启动指定的IIS应用程序池。

4.  go函数不支持默认参数

    C#中有许多的语法糖，让我们使用起来非常方便，而go里就没这么完美了，像函数的默认参数就不支持，而且还不支持函数重载。当然这样也有好处，使用起来直观一些。这也看出来go还确实是简洁了一些，很多东西都要自己去实现。

5.  命令行乱码

    因为go的文件编码是 UTF-8，而cmd的活动页是cp936（GBK），因此在中文Windows系统中，如果一个文本文件是UTF-8编码的，那么在cmd.exe命令行窗口中会有存在不能正常显示输出内容的情况。

    解决办法：在命令行中运行`chcp`查看活动页代码，默认应该会输出`936`，然后直接运行`chcp 65001`即可，这样就能正常显示中文了。

6.  go单元测试

    同目录下新建一个同名的`*_test.go`文件，定义函数名必须以`Test`开头，一般来讲，要测试哪个函数，后面就紧跟要测试的函数名。当运行测试函数没报错时，即单元测试通过。

### 最后

其实这里还有很多的东西都没有写清楚，也只是这次用到了，也就顺便提一下，如果要写得很完善的话，每一个点估计都能写一篇很长很长的文章了。因为个人的语言组织能力有限，并且对这些新知识点的理解也算不上透彻，所以先只在这里记录一下，等以后用得多了，理解也就深了，然后再来完善这些点吧。